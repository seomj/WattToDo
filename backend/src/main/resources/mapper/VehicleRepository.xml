<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.wtd.backend.repository.VehicleRepository">

    <select id="getEfficiencyByUserId" resultType="float">
        SELECT v.efficiency
        FROM vehicle v
        JOIN user u ON v.vehicle_id = u.vehicle_id
        WHERE u.user_id = #{userId}
        LIMIT 1
    </select>

    <resultMap id="VehicleResultMap" type="com.ssafy.wtd.backend.model.Vehicle">
        <id property="vehicleId" column="vehicle_id"/>
        <result property="model" column="model"/>
        <result property="efficiency" column="efficiency"/>
        <result property="batteryCapacity" column="battery_capacity"/>
        <result property="maxRange" column="max_range"/>
        <result property="fastChargeType" column="fast_charge_type"/>
        <result property="slowChargeType" column="slow_charge_type"/>

        <result property="createdAt" column="created_at"/>
    </resultMap>

    <select id="findByUserId" resultMap="VehicleResultMap">
        SELECT
        v.vehicle_id, v.model, v.efficiency, v.battery_capacity, v.max_range,
        v.fast_charge_type, v.slow_charge_type, v.created_at
        FROM vehicle v
        JOIN user u ON v.vehicle_id = u.vehicle_id
        WHERE u.user_id = #{userId}
        LIMIT 1
    </select>

    <select id="findSpecByModel" resultMap="VehicleResultMap">
        SELECT
        vehicle_id, model, efficiency, battery_capacity, max_range,
        fast_charge_type, slow_charge_type, created_at
        FROM vehicle
        WHERE model = #{model}
        AND (
        efficiency IS NOT NULL
        OR battery_capacity IS NOT NULL
        OR max_range IS NOT NULL
        OR fast_charge_type IS NOT NULL
        OR slow_charge_type IS NOT NULL
        )
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <insert id="insert" parameterType="com.ssafy.wtd.backend.model.Vehicle" useGeneratedKeys="true" keyProperty="vehicleId">
        INSERT INTO vehicle (
        model, efficiency, battery_capacity, max_range,
        fast_charge_type, slow_charge_type, created_at
        ) VALUES (
        #{model}, #{efficiency}, #{batteryCapacity}, #{maxRange},
        #{fastChargeType}, #{slowChargeType}, NOW()
        )
    </insert>

    <update id="updateByUserId" parameterType="com.ssafy.wtd.backend.model.Vehicle">
        UPDATE vehicle
        SET
        model = #{model},
        efficiency = #{efficiency},
        battery_capacity = #{batteryCapacity},
        max_range = #{maxRange},
        fast_charge_type = #{fastChargeType},
        slow_charge_type = #{slowChargeType}
        WHERE vehicle_id = #{vehicleId}
    </update>

    <delete id="deleteByUserId">
        DELETE FROM vehicle
        WHERE vehicle_id = #{vehicleId}
    </delete>

</mapper>